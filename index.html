<!DOCTYPE html>
<html lang="ne">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nepali Earning App - VIP कमाइ योजना</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <style>
        /* ========================================================================= */
        /* GLOBAL & FRIENDLY STYLES (Tailwind not covered) */
        /* ========================================================================= */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f3f4f6; /* Lighter background for a cleaner look */
            margin-bottom: 60px; 
        }
        .card { 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* Softer, modern shadow */
            border-radius: 1rem; /* More rounded corners */
        }
        .disabled-btn { cursor: not-allowed; opacity: 0.6; }
        
        /* Input focus style */
        input:focus, textarea:focus, select:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
        }

        /* VIP Card Styles */
        .vip-card {
            transition: all 0.3s ease;
        }
        .vip-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 20px -5px rgba(0, 0, 0, 0.15);
        }

        /* ========================================================================= */
        /* NAVIGATION & TABS */
        /* ========================================================================= */
        #bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            display: flex;
            background-color: #ffffff;
            border-top: 1px solid #e5e7eb;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.05);
            z-index: 40;
        }
        .nav-item {
            flex: 1;
            padding: 8px 0;
            text-align: center;
            font-size: 0.75rem;
            color: #6b7280;
            transition: color 0.2s;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            line-height: 1.2;
        }
        .nav-item i {
            font-size: 1.2rem;
            margin-bottom: 3px;
        }
        .nav-item.active-tab {
            color: #4f46e5;
        }
        
        /* ========================================================================= */
        /* CUSTOM UI COMPONENTS */
        /* ========================================================================= */
        /* Radio Tile Group for Deposit Methods */
        .radio-tile-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        .radio-tile-group label {
            flex: 1 1 30%;
            min-width: 100px; /* Ensure a minimum size */
            text-align: center;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem; /* Slightly larger radius */
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
        }
        .radio-tile-group input:checked + label {
            border-color: #4f46e5;
            background-color: #eef2ff;
            color: #4f46e5;
            box-shadow: 0 0 0 2px #4f46e5;
            transform: scale(1.03); /* Subtle scale effect */
        }
        .radio-tile-group input {
            display: none;
        }
        
        /* Referral Box */
        .referral-code-box {
            background-color: #eef2ff;
            border: 2px dashed #4f46e5;
            padding: 1rem;
            border-radius: 1rem;
            cursor: pointer;
        }
        
        /* Telegram Button */
        .telegram-btn {
            background-color: #0088CC; 
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 9999px; 
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .telegram-btn:hover { background-color: #0077B3; }
        
        /* Login/Register Background */
        #login-register-view {
             background: linear-gradient(135deg, #4f46e5 0%, #1e3a8a 100%); /* Blue gradient background */
        }
        #login-register-view .card {
             border-radius: 1.5rem;
        }
    </style>
</head>
<body class="min-h-screen">

    <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-sm transform transition-all duration-300 scale-100">
            <h3 id="modal-title" class="text-xl font-bold mb-3 text-indigo-600">सन्देश</h3>
            <p id="modal-content" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end">
                <button id="modal-close-btn" class="bg-indigo-600 text-white px-5 py-2 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">ठीक छ</button>
            </div>
        </div>
    </div>

    <div id="app-container" class="min-h-screen">

        <div id="login-register-view" class="flex items-center justify-center min-h-screen p-4">
             <div class="w-full max-w-md">
                 <div class="text-center mb-8">
                     <h1 class="text-5xl font-extrabold text-white drop-shadow-lg">Nepali Earning App</h1>
                     <p class="text-white opacity-80 mt-2">VIP कमाइ योजना</p>
                 </div>
                 <div id="login-view" class="bg-white p-8 rounded-2xl card">
                     <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">लगइन गर्नुहोस्</h2>
                     <form id="login-form">
                         <div class="mb-4">
                             <label for="login-username" class="block text-gray-700 font-semibold mb-2">प्रयोगकर्ता नाम</label>
                             <input type="text" id="login-username" class="w-full px-4 py-3 border border-gray-300 rounded-lg" required>
                         </div>
                         <div class="mb-6">
                             <label for="login-password" class="block text-gray-700 font-semibold mb-2">पासवर्ड</label>
                             <input type="password" id="login-password" class="w-full px-4 py-3 border border-gray-300 rounded-lg" required>
                         </div>
                         <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors text-lg shadow-md">लगइन</button>
                     </form>
                     <div id="login-status-message" class="mt-4 text-center text-red-600 font-semibold hidden"></div>
                     <p class="text-center text-gray-600 my-4">वा</p>
                     <button id="show-register-btn" class="w-full bg-gray-200 text-gray-800 py-3 rounded-lg font-semibold hover:bg-gray-300 transition-colors">नयाँ खाता बनाउनुहोस्</button>
                 </div>
                 
                 <div id="register-view" class="bg-white p-8 rounded-2xl card hidden">
                     <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">नयाँ खाता</h2>
                     <form id="register-form">
                         <div class="mb-4">
                             <label for="register-username" class="block text-gray-700 font-semibold mb-2">प्रयोगकर्ता नाम</label>
                             <input type="text" id="register-username" class="w-full px-4 py-3 border border-gray-300 rounded-lg" required>
                         </div>
                         <div class="mb-4">
                             <label for="register-password" class="block text-gray-700 font-semibold mb-2">पासवर्ड</label>
                             <input type="password" id="register-password" class="w-full px-4 py-3 border border-gray-300 rounded-lg" required>
                         </div>
                         <div class="mb-6">
                             <label for="register-referral-code" class="block text-gray-700 font-semibold mb-2">रेफरल कोड (वैकल्पिक)</label>
                             <input type="text" id="register-referral-code" class="w-full px-4 py-3 border border-gray-300 rounded-lg uppercase" placeholder="आमन्त्रित कोड प्रविष्ट गर्नुहोस्">
                             <p class="text-xs text-indigo-500 mt-1">रेफरल कोड प्रयोग गरे बापत रू. १५० बोनस पाउनुहोस्!</p>
                         </div>
                         <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold text-lg shadow-md">दर्ता र लगइन</button>
                         <button id="show-login-btn" type="button" class="w-full mt-4 text-center text-indigo-600 font-semibold hover:underline">पहिले नै खाता छ? लगइन गर्नुहोस्</button>
                     </form>
                 </div>
             </div>
        </div>

        <div id="dashboard-view" class="max-w-4xl mx-auto p-4 md:p-6 hidden">
            
            <header class="flex justify-between items-center mb-6 bg-white p-4 rounded-xl card space-x-4 sticky top-0 z-30">
                <div class="flex items-center space-x-4">
                    <h1 class="text-2xl font-bold text-indigo-600">VIP Earning</h1>
                    <a id="telegram-link-btn" href="#" target="_blank" class="telegram-btn flex items-center hidden text-sm py-1 px-3">
                        <i class="fab fa-telegram-plane mr-1"></i>
                        जोडिनुहोस्
                    </a>
                </div>

                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <span class="block text-sm text-gray-500" id="username-display"></span>
                        <span class="block text-xl font-bold text-green-600" id="user-balance">रू. ०</span>
                    </div>
                    <button id="logout-btn" class="bg-red-500 text-white w-10 h-10 rounded-full hover:bg-red-600 transition-colors flex items-center justify-center shadow-md"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </header>
            
            <main class="pb-20"> 

                <div id="home-tab" class="tab-content">

                    <div id="daily-checkin-btn-container" class="mb-6 p-4 bg-white card">
                        <button id="daily-checkin-btn" class="w-full flex items-center justify-center p-3 rounded-xl text-lg disabled:opacity-75 bg-amber-500 text-white font-bold hover:bg-amber-600">
                            <i class="fas fa-calendar-check mr-3"></i>
                            दैनिक आय प्राप्त गर्नुहोस् (रू. <span id="checkin-reward-display">०</span>)
                        </button>
                        <p id="vip-status-message" class="text-center mt-3 text-sm font-semibold text-gray-600"></p>
                    </div>

                    <h2 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2">सक्रिय VIP योजनाहरू</h2>
                    <div id="vip-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        </div>
                    
                    <div id="no-vips-message" class="text-center p-8 bg-white rounded-xl card mt-4 hidden">
                        <i class="fas fa-star text-4xl text-yellow-500 mb-2"></i>
                        <p class="text-gray-600 font-semibold">अहिले कुनै VIP योजना उपलब्ध छैनन्। एडमिनले नयाँ योजना थप्ने प्रतीक्षा गर्नुहोस्।</p>
                    </div>

                </div>

                <div id="deposit-tab" class="tab-content hidden">
                    <div class="bg-white p-6 card">
                        <h2 class="text-2xl font-bold mb-4 text-indigo-600"><i class="fas fa-money-check-alt mr-2"></i>रकम जम्मा गर्नुहोस्</h2>
                        <p id="min-deposit-info" class="text-sm font-semibold text-red-500 mb-4">न्यूनतम जम्मा रकम: रू. 500</p>

                        <form id="deposit-form" class="space-y-4">
                            <div class="mb-4">
                                <label class="block text-gray-700 font-semibold mb-3">भुक्तानी विधि छान्नुहोस्:</label>
                                <div class="radio-tile-group" id="deposit-methods-radio">
                                    <input type="radio" id="esewa" name="payment-method" value="eSewa" required>
                                    <label for="esewa"><i class="fas fa-mobile-alt mr-1"></i>eSewa</label>

                                    <input type="radio" id="khalti" name="payment-method" value="Khalti" required>
                                    <label for="khalti"><i class="fas fa-qrcode mr-1"></i>Khalti</label>

                                    <input type="radio" id="bank" name="payment-method" value="Bank Transfer" required>
                                    <label for="bank"><i class="fas fa-university mr-1"></i>Bank</label>
                                </div>
                            </div>

                            <div id="payment-details-box" class="bg-gray-100 p-4 rounded-lg border border-gray-300 text-sm hidden">
                                <p class="font-bold text-gray-800 mb-2">भुक्तानी गर्नको लागि प्रयोग हुने विवरण:</p>
                                <pre id="payment-details-display" class="whitespace-pre-wrap text-gray-700 font-mono text-base font-semibold"></pre>
                                <p class="text-xs text-red-500 mt-2">यस नम्बर/खातामा रकम ट्रान्सफर गर्नुहोस् र तलको फारममा Transaction Code भर्नुहोस्।</p>
                            </div>

                            <label class="block">
                                <span class="text-gray-700 font-semibold">जम्मा गर्न चाहेको रकम (रू.)</span>
                                <input type="number" id="deposit-amount" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg" min="500" placeholder="जस्तै: 1000" required>
                            </label>

                            <label class="block">
                                <span class="text-gray-700 font-semibold">भुक्तानीको Transaction Code/Reference No.</span>
                                <input type="text" id="transaction-code" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="Transaction Code अनिवार्य छ" required>
                                <p class="text-xs text-gray-500 mt-1">भुक्तानी गरेपछि प्राप्त हुने ट्रान्ज्याक्सन कोड यहाँ प्रविष्ट गर्नुहोस्।</p>
                            </label>

                            <button type="submit" id="deposit-submit-btn" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors text-lg shadow-md">जम्मा अनुरोध पठाउनुहोस्</button>
                        </form>
                    </div>
                </div>

                <div id="withdraw-tab" class="tab-content hidden">
                    <div class="bg-white p-6 card">
                        <h2 class="text-2xl font-bold mb-4 text-indigo-600"><i class="fas fa-wallet mr-2"></i>रकम निकाल्नुहोस्</h2>
                        <p id="min-withdraw-info" class="text-sm font-semibold text-red-500 mb-4">न्यूनतम निकासी रकम: रू. 400</p>

                        <div class="p-4 mb-4 bg-green-50 rounded-lg border border-green-200">
                            <p class="text-sm font-semibold text-green-700">तपाईंको वर्तमान ब्यालेन्स:</p>
                            <p id="current-withdraw-balance" class="text-2xl font-bold text-green-600 mt-1">रू. ०.००</p>
                        </div>
                        
                        <form id="withdraw-form" class="space-y-4">
                            <label class="block">
                                <span class="text-gray-700 font-semibold">निकासी रकम (रू.)</span>
                                <input type="number" id="withdraw-amount" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg" min="400" placeholder="निकाल्न चाहेको रकम" required>
                            </label>

                            <div class="mb-4">
                                <label class="block text-gray-700 font-semibold mb-2">निकासी विधि:</label>
                                <select id="withdraw-method" class="w-full px-4 py-3 border border-gray-300 rounded-lg" required>
                                    <option value="">विधि छान्नुहोस्</option>
                                    <option value="eSewa">eSewa</option>
                                    <option value="Khalti">Khalti</option>
                                    <option value="Bank Transfer">Bank Transfer</option>
                                </select>
                            </div>
                            
                            <label class="block">
                                <span class="text-gray-700 font-semibold">भुक्तानी खाता विवरण (eSewa/Khalti ID वा Bank A/C No.)</span>
                                <input type="text" id="withdraw-account-detail" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="आफ्नो खाता नम्बर/ID प्रविष्ट गर्नुहोस्" required>
                            </label>

                            <button type="submit" id="withdraw-submit-btn" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors text-lg shadow-md">निकासी अनुरोध पठाउनुहोस्</button>
                        </form>
                    </div>
                </div>

                <div id="history-tab" class="tab-content hidden">
                    <div class="bg-white p-6 card">
                        <h2 class="text-2xl font-bold mb-4 text-indigo-600"><i class="fas fa-history mr-2"></i>लेनदेनको इतिहास</h2>
                        
                        <div id="history-list" class="space-y-3">
                            </div>
                        
                        <div id="no-history-message" class="text-center p-8 bg-gray-50 rounded-xl mt-4 hidden">
                            <i class="fas fa-list-alt text-4xl text-gray-400 mb-2"></i>
                            <p class="text-gray-600 font-semibold">अहिलेसम्म कुनै लेनदेन रेकर्ड छैन।</p>
                        </div>
                    </div>
                </div>

                <div id="invite-tab" class="tab-content hidden">
                    <div class="bg-white p-6 card text-center">
                        <i class="fas fa-user-friends text-5xl text-indigo-500 mb-4"></i>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">साथीहरूलाई आमन्त्रित गर्नुहोस्!</h2>
                        <p class="text-gray-600 mb-4">तपाईंले आमन्त्रित गर्नुभएको साथीको VIP दैनिक आयमा **१०% कमिसन** पाउनुहुनेछ।</p>
                        
                        <div class="my-6">
                            <p class="text-lg font-semibold text-gray-700 mb-2">तपाईंको रेफरल कोड</p>
                            <div class="referral-code-box">
                                <span id="my-referral-code" class="text-3xl font-extrabold text-indigo-700 tracking-wider uppercase">Loading...</span>
                            </div>
                            <button id="copy-referral-btn" class="mt-3 bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors shadow-md"><i class="fas fa-copy mr-2"></i>कोड कपी गर्नुहोस्</button>
                        </div>
                        
                        <h3 class="text-xl font-bold mt-8 mb-3 text-gray-800">तपाईंको आमन्त्रित तथ्याङ्क</h3>
                        <div class="flex justify-around items-center bg-gray-50 p-4 rounded-xl">
                            <div class="text-center">
                                <p id="total-referrals" class="text-3xl font-bold text-green-600">०</p>
                                <p class="text-sm text-gray-500">कुल आमन्त्रित</p>
                            </div>
                            <div class="text-center">
                                <p id="referral-commission" class="text-3xl font-bold text-indigo-600">रू. ०</p>
                                <p class="text-sm text-gray-500">कुल कमिसन</p>
                            </div>
                        </div>
                    </div>
                </div>


                <div id="admin-tab" class="tab-content hidden" data-is-admin="false">
                    <div class="bg-white p-6 card space-y-8">
                        <h2 class="text-2xl font-bold text-gray-800 border-b pb-3 border-gray-200">एडमिन प्यानल</h2>

                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                            <h3 class="text-xl font-bold mb-4 text-blue-700"><i class="fas fa-users mr-2"></i>प्रयोगकर्ता व्यवस्थापन (<span id="total-users-count">0</span> प्रयोगकर्ताहरू)</h3>
                            <div class="bg-indigo-600 text-white p-4 rounded-xl mb-4 text-center shadow-md">
                                <p class="text-sm font-semibold opacity-80">एपमा रहेको कुल रकम (प्रयोगकर्ताहरूको ब्यालेन्स)</p>
                                <p id="app-total-balance" class="text-3xl font-extrabold mt-1">रू. ०.००</p>
                            </div>
                            <div id="user-management-list" class="space-y-4"></div>
                        </div>

                        <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                            <h3 class="text-xl font-bold mb-4 text-yellow-700"><i class="fas fa-crown mr-2"></i>VIP योजना व्यवस्थापन</h3>
                            <form id="add-vip-form" class="space-y-3 mb-6 p-3 bg-white rounded-lg shadow-md">
                                <p class="font-semibold text-gray-700">नयाँ VIP योजना थप्नुहोस्/सम्पादन गर्नुहोस्:</p>
                                <input type="text" id="vip-name" class="w-full px-3 py-2 border rounded-lg" placeholder="VIP नाम (जस्तै: VIP 1, Standard)" required>
                                <input type="number" id="vip-price" class="w-full px-3 py-2 border rounded-lg" placeholder="मूल्य (रू.)" min="1" required>
                                <input type="number" id="vip-daily-income" class="w-full px-3 py-2 border rounded-lg" placeholder="दैनिक आय (रू.)" min="1" required>
                                <input type="number" id="vip-duration-days" class="w-full px-3 py-2 border rounded-lg" placeholder="अवधि (दिनमा, जस्तै: 30)" min="1" required>
                                <button type="submit" class="w-full bg-yellow-600 text-white py-2 rounded-lg font-semibold hover:bg-yellow-700 shadow-md"><i class="fas fa-plus mr-2"></i>VIP योजना थप्नुहोस्</button>
                            </form>

                            <h4 class="text-lg font-semibold mt-6 mb-3 text-yellow-700">सक्रिय VIP योजनाहरूको सूची</h4>
                            <div id="active-vips-list" class="space-y-2">
                                </div>
                        </div>

                        <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                            <h3 class="text-xl font-bold mb-4 text-green-700"><i class="fas fa-coins mr-2"></i>वित्तीय सीमाहरू</h3>
                            <form id="financial-limits-form" class="space-y-4">
                                <label class="block">
                                    <span class="text-gray-700 font-semibold">न्यूनतम जम्मा (Minimum Deposit)</span>
                                    <input type="number" id="min-deposit" class="mt-1 block w-full px-3 py-2 border rounded-lg" min="10" placeholder="न्यूनतम जम्मा रकम" required>
                                </label>
                                <label class="block">
                                    <span class="text-gray-700 font-semibold">न्यूनतम निकासी (Minimum Withdrawal)</span>
                                    <input type="number" id="min-withdraw" class="mt-1 block w-full px-3 py-2 border rounded-lg" min="10" placeholder="न्यूनतम निकासी रकम" required>
                                </label>
                                <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-lg font-semibold hover:bg-green-700 shadow-md">सीमाहरू बचत गर्नुहोस्</button>
                            </form>
                        </div>
                        
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <h3 class="text-xl font-bold mb-4 text-gray-700"><i class="fas fa-cogs mr-2"></i>एप सेटिङहरू (Deposit Details)</h3>
                        <form id="settings-form" class="space-y-4">
                            <label class="block">
                                <span class="text-gray-700 font-semibold">Telegram Channel Link</span>
                                <input type="url" id="telegram-link" class="mt-1 block w-full px-3 py-2 border rounded-lg" placeholder="https://t.me/yourchannel">
                            </label>
                            <label class="block">
                                <span class="text-gray-700 font-semibold">eSewa ID (फोन नम्बर)</span>
                                <input type="text" id="esewa-id-input" class="mt-1 block w-full px-3 py-2 border rounded-lg" placeholder="eSewa फोन नम्बर" required>
                            </label>
                           <label class="block">
                                <span class="text-gray-700 font-semibold">Khalti ID</span>
                                <input type="text" id="khalti-id-input" class="mt-1 block w-full px-3 py-2 border rounded-lg" placeholder="आफ्नो खल्ती ID" required>
                            </label>
                            <label class="block">
                                <span class="text-gray-700 font-semibold">बैंक विवरण</span>
                                <textarea id="bank-details-input" class="mt-1 block w-full px-3 py-2 border rounded-lg" rows="3" placeholder="बैंकको नाम, खाता नम्बर, खाता धारकको नाम आदि प्रविष्ट गर्नुहोस्" required></textarea>
                            </label>
                            <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded-lg font-semibold hover:bg-indigo-700 shadow-md">सेटिङहरू बचत गर्नुहोस्</button>
                        </form>
                        </div>

                        <h3 class="text-xl font-bold mb-4 text-gray-800 border-b pb-3 border-gray-200">विचाराधीन अनुरोधहरू (Pending Requests)</h3>
                        <div id="pending-deposits-section">
                             <h4 class="text-lg font-medium mb-2 text-indigo-700">विचाराधीन जम्मा अनुरोधहरू</h4>
                            <div id="pending-deposits-list" class="space-y-3"></div>
                        </div>
                        <div id="pending-withdrawals-section" class="mt-6">
                            <h4 class="text-lg font-medium mb-2 text-indigo-700">विचाराधीन निकासी अनुरोधहरू</h4>
                            <div id="pending-withdrawals-list" class="space-y-3"></div>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>
    
    <nav id="bottom-nav" class="hidden">
        <button data-tab="home" class="nav-item active-tab"><i class="fas fa-crown"></i>VIP योजना</button>
        <button data-tab="history" class="nav-item"><i class="fas fa-history"></i>इतिहास</button>
        <button data-tab="deposit" class="nav-item"><i class="fas fa-money-check-alt"></i>जम्मा</button>
        <button data-tab="withdraw" class="nav-item"><i class="fas fa-wallet"></i>निकाल्नुहोस्</button>
        <button data-tab="invite" class="nav-item"><i class="fas fa-user-friends"></i>आमन्त्रित</button>
        <button data-tab="admin" class="nav-item hidden"><i class="fas fa-user-shield"></i>एडमिन</button>
    </nav>
    <script>
    // --- IIFE to encapsulate the entire app logic ---
    (() => {
        const DB_KEY = 'avaAppDB_v26_deposit_fix'; // Changed DB_KEY for fresh start/update
        const REFERRAL_BONUS_AMOUNT = 150.00; 
        const REFERRAL_COMMISSION_RATE = 0.10; // 10% commission on VIP daily income
        const ADMIN_USERNAME = 'admin'; // Predefined admin username
        const ADMIN_PASSWORD = 'deshraj#66'; // Predefined admin password (Change this in a real app!)

        let loggedInUsername = sessionStorage.getItem('loggedInUser');

        const elements = {
            // Modal
            modal: document.getElementById('custom-modal'),
            modalCloseBtn: document.getElementById('modal-close-btn'),
            modalTitle: document.getElementById('modal-title'),
            modalContent: document.getElementById('modal-content'),

            // Views & Auth
            loginRegisterView: document.getElementById('login-register-view'),
            dashboardView: document.getElementById('dashboard-view'),
            loginForm: document.getElementById('login-form'),
            registerForm: document.getElementById('register-form'),
            loginView: document.getElementById('login-view'),
            registerView: document.getElementById('register-view'),
            showRegisterBtn: document.getElementById('show-register-btn'),
            showLoginBtn: document.getElementById('show-login-btn'),
            loginStatusMessage: document.getElementById('login-status-message'),
            logoutBtn: document.getElementById('logout-btn'),
            
            // NAVIGATION ELEMENTS
            bottomNav: document.getElementById('bottom-nav'),
            tabButtons: document.querySelectorAll('.nav-item'), 
            adminTabButton: document.querySelector('#bottom-nav [data-tab="admin"]'), 
            
            // Dashboard Header
            usernameDisplay: document.getElementById('username-display'),
            userBalance: document.getElementById('user-balance'),
            telegramLinkBtn: document.getElementById('telegram-link-btn'),

            // Home Tab (VIP & Earning)
            dailyCheckinBtn: document.getElementById('daily-checkin-btn'),
            checkinRewardDisplay: document.getElementById('checkin-reward-display'),
            vipStatusMessage: document.getElementById('vip-status-message'),
            vipList: document.getElementById('vip-list'),
            noVipsMessage: document.getElementById('no-vips-message'),
            
            // Deposit Tab
            depositForm: document.getElementById('deposit-form'),
            depositMethodsRadio: document.getElementById('deposit-methods-radio'),
            paymentDetailsBox: document.getElementById('payment-details-box'),
            paymentDetailsDisplay: document.getElementById('payment-details-display'),
            minDepositInfo: document.getElementById('min-deposit-info'),
            depositAmountInput: document.getElementById('deposit-amount'),

            // Withdraw Tab
            withdrawForm: document.getElementById('withdraw-form'),
            currentWithdrawBalance: document.getElementById('current-withdraw-balance'),
            minWithdrawInfo: document.getElementById('min-withdraw-info'),
            
            // History Tab
            historyList: document.getElementById('history-list'),
            noHistoryMessage: document.getElementById('no-history-message'),

            // Invite Tab Elements
            myReferralCode: document.getElementById('my-referral-code'),
            totalReferrals: document.getElementById('total-referrals'),
            referralCommission: document.getElementById('referral-commission'),
            copyReferralBtn: document.getElementById('copy-referral-btn'),
            
            // Admin Panel Elements
            totalUsersCount: document.getElementById('total-users-count'),
            appTotalBalance: document.getElementById('app-total-balance'),
            userManagementList: document.getElementById('user-management-list'),
            pendingDepositsList: document.getElementById('pending-deposits-list'),
            pendingWithdrawalsList: document.getElementById('pending-withdrawals-list'),

            // Admin VIP Management
            addVipForm: document.getElementById('add-vip-form'),
            activeVipsList: document.getElementById('active-vips-list'),
            
            // Admin Settings Input
            financialLimitsForm: document.getElementById('financial-limits-form'),
            minDepositInput: document.getElementById('min-deposit'),
            minWithdrawInput: document.getElementById('min-withdraw'),
            settingsForm: document.getElementById('settings-form'),
            telegramLinkInput: document.getElementById('telegram-link'),
            esewaIdInput: document.getElementById('esewa-id-input'), // Corrected to match HTML ID
            khaltiIdInput: document.getElementById('khalti-id-input'), // Corrected to match HTML ID
            bankDetailsInput: document.getElementById('bank-details-input'), // Corrected to match HTML ID

            // Utility
            allTabContents: document.querySelectorAll('.tab-content')
        };
        
        // =========================================================================
        // 1. DATA MANAGEMENT (Local Storage)
        // =========================================================================

        const initialDB = {
            users: [{
                username: ADMIN_USERNAME,
                password: ADMIN_PASSWORD,
                balance: 10000.00,
                isAdmin: true,
                referralCode: ADMIN_USERNAME.toUpperCase(),
                referredBy: null,
                lastCheckin: 0,
                activeVips: [], // { id, name, dailyIncome, durationDays, expiryTimestamp }
                history: [] // { type: 'DEPOSIT'/'WITHDRAW'/'VIP_BUY'/'CHECKIN'/'COMMISSION', amount, status, timestamp, details }
            }],
            appSettings: {
                minDeposit: 500,
                minWithdraw: 400,
                telegramLink: 'https://t.me/nepaliearningofficial',
                esewaId: '98********', // Default ID
                khaltiId: '98********', // Default ID
                bankDetails: 'Bank Name: Nabil Bank\nA/C No: 123456789\nA/C Holder: Earning App Pvt. Ltd.', // Default details
            },
            vips: [{
                id: 'V1', name: 'VIP 1', price: 1000, dailyIncome: 50, durationDays: 30
            }, {
                id: 'V2', name: 'VIP 2', price: 3000, dailyIncome: 180, durationDays: 45
            }],
            pendingDeposits: [], // { id, username, amount, method, code, timestamp, status: 'PENDING' }
            pendingWithdrawals: [], // { id, username, amount, method, accountDetail, timestamp, status: 'PENDING' }
        };

        const getDB = () => {
            const dbString = localStorage.getItem(DB_KEY);
            let db = dbString ? JSON.parse(dbString) : initialDB;
            
            // Ensure new keys exist if loading old DB format
            if (!db.appSettings.esewaId) {
                db.appSettings.esewaId = initialDB.appSettings.esewaId;
                db.appSettings.khaltiId = initialDB.appSettings.khaltiId;
                db.appSettings.bankDetails = initialDB.appSettings.bankDetails;
            }
            return db;
        };

        const saveDB = (db) => {
            localStorage.setItem(DB_KEY, JSON.stringify(db));
        };

        const getNextId = (items, prefix) => {
            const lastItem = items.length > 0 ? items[items.length - 1] : null;
            if (!lastItem) return `${prefix}1`;
            // Simple integer increment for ID (assuming IDs are like V1, V2, D1, W1)
            const lastIdNumber = parseInt(lastItem.id.replace(prefix, '')) || 0;
            return `${prefix}${lastIdNumber + 1}`;
        };

        // =========================================================================
        // 2. UTILITY FUNCTIONS
        // =========================================================================

        const formatCurrency = (amount) => `रू. ${parseFloat(amount).toFixed(2).toLocaleString('en-IN')}`;

        const showModal = (title, content) => {
            elements.modalTitle.textContent = title;
            elements.modalContent.textContent = content;
            elements.modal.classList.remove('hidden');
            elements.modal.classList.add('flex');
        };

        const hideModal = () => {
            elements.modal.classList.add('hidden');
            elements.modal.classList.remove('flex');
        };

        const showView = (viewId) => {
            elements.loginRegisterView.classList.add('hidden');
            elements.dashboardView.classList.add('hidden');
            
            if (viewId === 'login-register-view') {
                elements.loginRegisterView.classList.remove('hidden');
                elements.bottomNav.classList.add('hidden');
            } else if (viewId === 'dashboard-view') {
                elements.dashboardView.classList.remove('hidden');
                elements.bottomNav.classList.remove('hidden');
                // Ensure the user is still logged in before showing dashboard
                if (!loggedInUsername) {
                    showView('login-register-view');
                    return;
                }
                // Default to home tab
                showTab('home');
                refreshDashboard();
            }
        };

        const showTab = (tabId) => {
            elements.allTabContents.forEach(tab => {
                tab.classList.add('hidden');
            });
            document.getElementById(`${tabId}-tab`).classList.remove('hidden');

            elements.tabButtons.forEach(btn => {
                btn.classList.remove('active-tab');
            });
            document.querySelector(`.nav-item[data-tab="${tabId}"]`).classList.add('active-tab');
            
            // Refresh content specific to the tab
            if (tabId === 'home') renderVipList();
            if (tabId === 'deposit') updateDepositUI();
            if (tabId === 'withdraw') updateWithdrawUI();
            if (tabId === 'history') renderHistory();
            if (tabId === 'invite') renderInviteTab();
            if (tabId === 'admin') renderAdminPanel();
        };

        // =========================================================================
        // 3. AUTH LOGIC
        // =========================================================================

        const handleLogin = (e) => {
            e.preventDefault();
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value;
            
            const db = getDB();
            const user = db.users.find(u => u.username === username);
            
            elements.loginStatusMessage.textContent = '';
            elements.loginStatusMessage.classList.add('hidden');

            if (user && user.password === password) {
                loggedInUsername = username;
                sessionStorage.setItem('loggedInUser', username);
                checkAdminStatus(user);
                showView('dashboard-view');
            } else {
                elements.loginStatusMessage.textContent = 'अमान्य प्रयोगकर्ता नाम वा पासवर्ड।';
                elements.loginStatusMessage.classList.remove('hidden');
            }
        };

        const handleRegister = (e) => {
            e.preventDefault();
            const username = document.getElementById('register-username').value.trim();
            const password = document.getElementById('register-password').value;
            const referralCode = document.getElementById('register-referral-code').value.trim().toUpperCase();

            let db = getDB();
            
            if (db.users.some(u => u.username === username)) {
                showModal('त्रुटि', 'यो प्रयोगकर्ता नाम पहिले नै दर्ता भइसकेको छ।');
                return;
            }

            let initialBalance = 0;
            let referrerUser = null;

            // Find referrer by matching referralCode
            if (referralCode) {
                referrerUser = db.users.find(u => u.referralCode === referralCode);
                if (referrerUser) {
                    initialBalance = REFERRAL_BONUS_AMOUNT; // Grant bonus for using a valid code
                } else {
                    showModal('जानकारी', 'तपाईंले प्रविष्ट गर्नुभएको रेफरल कोड अमान्य छ। तपाईंले बोनस पाउनुहुने छैन।');
                }
            }

            const newUser = {
                username: username,
                password: password,
                balance: initialBalance,
                isAdmin: false,
                referralCode: username.toUpperCase(), // Use username as default referral code
                referredBy: referrerUser ? referrerUser.referralCode : null, // Store referrer's code
                lastCheckin: 0,
                activeVips: [],
                history: initialBalance > 0 ? [{
                    type: 'BONUS',
                    amount: initialBalance,
                    status: 'COMPLETED',
                    timestamp: Date.now(),
                    details: `Registration Bonus via Referral Code ${referralCode}`
                }] : []
            };

            db.users.push(newUser);
            saveDB(db);

            loggedInUsername = username;
            sessionStorage.setItem('loggedInUser', username);
            showView('dashboard-view');
        };
        
        const handleLogout = () => {
            loggedInUsername = null;
            sessionStorage.removeItem('loggedInUser');
            elements.adminTabButton.classList.add('hidden'); // Hide admin tab on logout
            showView('login-register-view');
        };

        const checkAdminStatus = (user) => {
            if (user && user.isAdmin) {
                elements.adminTabButton.classList.remove('hidden');
            } else {
                elements.adminTabButton.classList.add('hidden');
            }
        };
        
        // =========================================================================
        // 4. DASHBOARD / HOME TAB LOGIC
        // =========================================================================

        const refreshDashboard = () => {
            const db = getDB();
            const user = db.users.find(u => u.username === loggedInUsername);
            if (!user) {
                handleLogout();
                return;
            }

            // 1. Check/Update VIP Income and Expiry
            const now = Date.now();
            let hasActiveVip = false;
            let totalDailyIncome = 0;

            // Filter out expired VIPs
            user.activeVips = user.activeVips.filter(vip => {
                if (vip.expiryTimestamp > now) {
                    totalDailyIncome += vip.dailyIncome;
                    hasActiveVip = true;
                    return true;
                } else {
                    // Optional: Add a history entry for VIP expiry if not already there
                    const expiryDetail = `${vip.name} has expired after ${vip.durationDays} days.`;
                    if (!user.history.some(h => h.type === 'VIP_EXPIRED' && h.details.includes(expiryDetail))) {
                         user.history.push({
                            type: 'VIP_EXPIRED',
                            amount: 0, 
                            status: 'COMPLETED',
                            timestamp: now,
                            details: expiryDetail
                        });
                    }
                    return false;
                }
            });

            // 2. Update UI with User Data
            elements.usernameDisplay.textContent = user.username;
            elements.userBalance.textContent = formatCurrency(user.balance);
            elements.currentWithdrawBalance.textContent = formatCurrency(user.balance); // For Withdraw Tab
            
            // 3. Daily Check-in Button Status
            const lastCheckinDate = new Date(user.lastCheckin).toDateString();
            const todayDate = new Date().toDateString();

            elements.checkinRewardDisplay.textContent = totalDailyIncome.toFixed(2);
            elements.dailyCheckinBtn.disabled = true;
            elements.vipStatusMessage.className = 'text-center mt-3 text-sm font-semibold';

            if (hasActiveVip) {
                if (lastCheckinDate === todayDate) {
                    elements.dailyCheckinBtn.disabled = true;
                    elements.dailyCheckinBtn.textContent = 'दैनिक आय प्राप्त गर्नुहोस् (आजको लागि भयो)';
                    elements.dailyCheckinBtn.classList.remove('bg-amber-500', 'hover:bg-amber-600');
                    elements.dailyCheckinBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                    elements.vipStatusMessage.textContent = `तपाईंको कुल दैनिक आय: ${formatCurrency(totalDailyIncome)}`;
                    elements.vipStatusMessage.classList.add('text-green-600');
                } else {
                    elements.dailyCheckinBtn.disabled = false;
                    elements.dailyCheckinBtn.textContent = `दैनिक आय प्राप्त गर्नुहोस् (रू. ${totalDailyIncome.toFixed(2)})`;
                    elements.dailyCheckinBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    elements.dailyCheckinBtn.classList.add('bg-amber-500', 'hover:bg-amber-600');
                    elements.vipStatusMessage.textContent = `तपाईंको कुल दैनिक आय: ${formatCurrency(totalDailyIncome)}`;
                    elements.vipStatusMessage.classList.add('text-green-600');
                }
            } else {
                elements.dailyCheckinBtn.disabled = true;
                elements.dailyCheckinBtn.textContent = 'VIP योजना किन्नुहोस् (आय प्राप्त गर्न)';
                elements.dailyCheckinBtn.classList.remove('bg-amber-500', 'hover:bg-amber-600');
                elements.dailyCheckinBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                elements.vipStatusMessage.textContent = 'दैनिक आय प्राप्त गर्न कृपया कुनै VIP योजना खरिद गर्नुहोस्।';
                elements.vipStatusMessage.classList.add('text-red-500');
            }

            // 4. Update Settings (Min Deposit/Withdraw)
            elements.minDepositInfo.textContent = `न्यूनतम जम्मा रकम: ${formatCurrency(db.appSettings.minDeposit)}`;
            elements.minWithdrawInfo.textContent = `न्यूनतम निकासी रकम: ${formatCurrency(db.appSettings.minWithdraw)}`;
            elements.depositAmountInput.min = db.appSettings.minDeposit;
            document.getElementById('withdraw-amount').min = db.appSettings.minWithdraw;
            
            // 5. Update Telegram Link
            if (db.appSettings.telegramLink) {
                elements.telegramLinkBtn.href = db.appSettings.telegramLink;
                elements.telegramLinkBtn.classList.remove('hidden');
            } else {
                 elements.telegramLinkBtn.classList.add('hidden');
            }

            // 6. Save updated user data (in case of VIP expiry)
            saveDB(db);
            checkAdminStatus(user);
            renderVipList(); // Re-render the VIP list to show active status
        };

        const handleDailyCheckin = () => {
            let db = getDB();
            let user = db.users.find(u => u.username === loggedInUsername);
            if (!user) return;
            
            const lastCheckinDate = new Date(user.lastCheckin).toDateString();
            const todayDate = new Date().toDateString();

            if (lastCheckinDate === todayDate) {
                showModal('जानकारी', 'तपाईंले आजको दैनिक आय पहिले नै प्राप्त गरिसक्नुभयो। भोलि फेरि प्रयास गर्नुहोस्।');
                return;
            }
            
            let totalDailyIncome = user.activeVips.reduce((sum, vip) => sum + vip.dailyIncome, 0);

            if (totalDailyIncome === 0) {
                 showModal('जानकारी', 'आय प्राप्त गर्नको लागि कृपया कुनै VIP योजना खरिद गर्नुहोस्।');
                 return;
            }

            user.balance += totalDailyIncome;
            user.lastCheckin = Date.now();

            // Add history entry
             user.history.push({
                type: 'CHECKIN',
                amount: totalDailyIncome,
                status: 'COMPLETED',
                timestamp: Date.now(),
                details: `Daily Income from VIPs`
            });

            // Commission Logic (10% of VIP daily income to referrer)
            if (user.referredBy) {
                // user.referredBy holds the referrer's referralCode
                const referrer = db.users.find(u => u.referralCode === user.referredBy); 
                if (referrer) {
                    const commissionAmount = totalDailyIncome * REFERRAL_COMMISSION_RATE;
                    referrer.balance += commissionAmount;
                    
                    // Add history for referrer
                    referrer.history.push({
                        type: 'COMMISSION',
                        amount: commissionAmount,
                        status: 'COMPLETED',
                        timestamp: Date.now(),
                        details: `10% Commission from ${user.username}'s Daily Income`
                    });
                }
            }

            saveDB(db);
            refreshDashboard();
            showModal('सफलता', `तपाईंले सफलतापूर्वक ${formatCurrency(totalDailyIncome)} को दैनिक आय प्राप्त गर्नुभयो!`);
        };

        const renderVipList = () => {
            const db = getDB();
            const user = db.users.find(u => u.username === loggedInUsername);
            if (!user) return;
            
            elements.vipList.innerHTML = '';
            
            if (db.vips.length === 0) {
                 elements.noVipsMessage.classList.remove('hidden');
                 return;
            }
            elements.noVipsMessage.classList.add('hidden');

            db.vips.forEach(vip => {
                // Check active VIP by its ID
                const activeVip = user.activeVips.find(v => v.id === vip.id);
                const isActive = !!activeVip;
                
                let buttonText = 'VIP किन्नुहोस्';
                let buttonClass = 'bg-indigo-600 hover:bg-indigo-700';
                let expiryText = '';

                if (isActive) {
                    buttonText = 'सक्रिय';
                    buttonClass = 'bg-green-600 cursor-not-allowed disabled:opacity-100';
                    const expiryDate = new Date(activeVip.expiryTimestamp);
                    expiryText = `<p class="text-sm text-green-700 font-semibold mt-2">म्याद समाप्त हुने मिति: ${expiryDate.toLocaleDateString('ne-NP')}</p>`;
                }

                const vipCard = document.createElement('div');
                vipCard.className = 'vip-card bg-white p-5 card border border-indigo-200';
                vipCard.innerHTML = `
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-2xl font-bold text-indigo-700">${vip.name}</h3>
                        <span class="text-3xl font-extrabold text-red-500">${formatCurrency(vip.price)}</span>
                    </div>
                    <ul class="space-y-2 text-gray-700">
                        <li class="flex justify-between items-center text-lg"><i class="fas fa-chart-line text-green-500 mr-2"></i> दैनिक आय: <span class="font-bold text-green-600">${formatCurrency(vip.dailyIncome)}</span></li>
                        <li class="flex justify-between items-center"><i class="fas fa-clock text-amber-500 mr-2"></i> अवधि: <span class="font-bold">${vip.durationDays} दिन</span></li>
                        <li class="flex justify-between items-center"><i class="fas fa-hand-holding-usd text-blue-500 mr-2"></i> कुल फिर्ती: <span class="font-bold">${formatCurrency(vip.dailyIncome * vip.durationDays)}</span></li>
                    </ul>
                    ${expiryText}
                    <button data-vip-id="${vip.id}" class="buy-vip-btn w-full mt-5 text-white py-2 rounded-lg font-semibold transition-colors shadow-md ${buttonClass}" ${isActive ? 'disabled' : ''}>
                        ${buttonText}
                    </button>
                `;
                elements.vipList.appendChild(vipCard);
            });

            // Add event listeners for new buttons
            document.querySelectorAll('.buy-vip-btn').forEach(button => {
                button.addEventListener('click', handleVipPurchase);
            });
        };

        const handleVipPurchase = (e) => {
            const vipId = e.currentTarget.getAttribute('data-vip-id');
            let db = getDB();
            let user = db.users.find(u => u.username === loggedInUsername);
            const vip = db.vips.find(v => v.id === vipId);

            if (!user || !vip) return;

            if (user.balance < vip.price) {
                showModal('अपर्याप्त ब्यालेन्स', `VIP किन्नको लागि तपाईंलाई ${formatCurrency(vip.price)} चाहिन्छ, तर तपाईंको ब्यालेन्स ${formatCurrency(user.balance)} मात्र छ। कृपया रकम जम्मा गर्नुहोस्।`);
                return;
            }
            
            // Check if user already has this VIP
            if (user.activeVips.some(v => v.id === vip.id)) { // FIX: Check by ID
                showModal('त्रुटि', `तपाईंसँग पहिले नै '${vip.name}' सक्रिय छ।`);
                return;
            }

            // Deduct price and activate VIP
            user.balance -= vip.price;
            
            // Ensure all VIP properties are correctly saved
            user.activeVips.push({
                id: vip.id, 
                name: vip.name,
                dailyIncome: vip.dailyIncome,
                durationDays: vip.durationDays,
                expiryTimestamp: Date.now() + (vip.durationDays * 24 * 60 * 60 * 1000)
            });

            // Add history entry
             user.history.push({
                type: 'VIP_BUY',
                amount: vip.price * -1,
                status: 'COMPLETED',
                timestamp: Date.now(),
                details: `Purchased VIP Plan: ${vip.name}`
            });

            saveDB(db);
            refreshDashboard();
            showModal('सफलता', `तपाईंले सफलतापूर्वक ${vip.name} खरिद गर्नुभयो! तपाईंको दैनिक आय अब सुरु भयो।`);
        };

        // =========================================================================
        // 5. DEPOSIT LOGIC (FIXED)
        // =========================================================================
        
        const updateDepositUI = () => {
            const db = getDB();
            // Clear payment details on tab switch
            elements.paymentDetailsBox.classList.add('hidden');
            elements.paymentDetailsDisplay.textContent = '';
            
            // Add listener to show payment details when a method is selected
            elements.depositMethodsRadio.querySelectorAll('input[name="payment-method"]').forEach(radio => {
                // Remove previous listener to prevent duplication
                radio.removeEventListener('change', showPaymentDetails); 
                
                // Add new listener
                radio.addEventListener('change', showPaymentDetails);
            });

            // Function to show details based on selected method
            function showPaymentDetails(e) {
                const method = e.target.value;
                elements.paymentDetailsBox.classList.remove('hidden');
                let details = '';
                
                if (method === 'eSewa') {
                    details = `eSewa ID/Mobile No: ${db.appSettings.esewaId || 'एडमिनले सेट गरेको छैन'}\nAccount Name: VIP Earning App`;
                } else if (method === 'Khalti') {
                     details = `Khalti ID/Mobile No: ${db.appSettings.khaltiId || 'एडमिनले सेट गरेको छैन'}\nAccount Name: VIP Earning App`;
                } else if (method === 'Bank Transfer') {
                     details = db.appSettings.bankDetails || 'बैंक विवरण उपलब्ध छैन।';
                }
                
                elements.paymentDetailsDisplay.textContent = details;
            }
            
            // Clear checked radio button on tab switch for fresh state
             elements.depositMethodsRadio.querySelectorAll('input[name="payment-method"]').forEach(radio => {
                radio.checked = false;
            });
        };

        const handleDeposit = (e) => {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('deposit-amount').value);
            const method = document.querySelector('input[name="payment-method"]:checked')?.value;
            const code = document.getElementById('transaction-code').value.trim();

            let db = getDB();
            
            if (!method) {
                showModal('त्रुटि', 'कृपया भुक्तानी विधि छान्नुहोस्।');
                return;
            }
            
            if (amount < db.appSettings.minDeposit) {
                 showModal('त्रुटि', `न्यूनतम जम्मा रकम ${formatCurrency(db.appSettings.minDeposit)} हो।`);
                 return;
            }

            const newDeposit = {
                id: getNextId(db.pendingDeposits, 'D'),
                username: loggedInUsername,
                amount: amount,
                method: method,
                code: code,
                timestamp: Date.now(),
                status: 'PENDING'
            };

            db.pendingDeposits.push(newDeposit);
            
            // Add history entry (status PENDING)
            db.users.find(u => u.username === loggedInUsername).history.push({
                type: 'DEPOSIT',
                amount: amount,
                status: 'PENDING',
                timestamp: Date.now(),
                details: `Deposit of ${formatCurrency(amount)} via ${method}. Code: ${code}`
            });

            saveDB(db);
            e.target.reset(); // Clear form
            elements.paymentDetailsBox.classList.add('hidden');
            
            if (loggedInUsername === ADMIN_USERNAME) renderAdminPanel();
            
            showModal('अनुरोध सफल', `तपाईंको ${formatCurrency(amount)} को जम्मा अनुरोध सफलतापूर्वक पठाइएको छ। एडमिनले अनुमोदन गरेपछि ब्यालेन्स थपिनेछ।`);
        };


        // =========================================================================
        // 6. WITHDRAW LOGIC
        // =========================================================================

        const updateWithdrawUI = () => {
            const db = getDB();
            const user = db.users.find(u => u.username === loggedInUsername);
             if (user) {
                elements.currentWithdrawBalance.textContent = formatCurrency(user.balance);
            }
        };
        
        const handleWithdraw = (e) => {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('withdraw-amount').value);
            const method = document.getElementById('withdraw-method').value;
            const accountDetail = document.getElementById('withdraw-account-detail').value.trim();

            let db = getDB();
            let user = db.users.find(u => u.username === loggedInUsername);
            
            if (!user) return;
            
            if (amount < db.appSettings.minWithdraw) {
                 showModal('त्रुटि', `न्यूनतम निकासी रकम ${formatCurrency(db.appSettings.minWithdraw)} हो।`);
                 return;
            }
            
            if (amount > user.balance) {
                showModal('अपर्याप्त ब्यालेन्स', `तपाईंको ब्यालेन्स ${formatCurrency(user.balance)} मात्र छ। ${formatCurrency(amount)} निकाल्न सकिँदैन।`);
                return;
            }
            
            // Deduct the amount immediately 
            user.balance -= amount;

            const newWithdrawal = {
                id: getNextId(db.pendingWithdrawals, 'W'),
                username: loggedInUsername,
                amount: amount,
                method: method,
                accountDetail: accountDetail,
                timestamp: Date.now(),
                status: 'PENDING'
            };

            db.pendingWithdrawals.push(newWithdrawal);
            
            // Add history entry (negative amount to show deduction, status PENDING)
            user.history.push({
                type: 'WITHDRAW',
                amount: amount * -1,
                status: 'PENDING',
                timestamp: Date.now(),
                details: `Withdrawal of ${formatCurrency(amount)} via ${method}`
            });

            saveDB(db);
            e.target.reset(); // Clear form
            
            refreshDashboard();
            if (loggedInUsername === ADMIN_USERNAME) renderAdminPanel();
            
            showModal('अनुरोध सफल', `तपाईंको ${formatCurrency(amount)} को निकासी अनुरोध सफलतापूर्वक पठाइएको छ। एडमिनले अनुमोदन गरेपछि रकम तपाईंको खातामा आउनेछ।`);
        };


        // =========================================================================
        // 7. HISTORY LOGIC
        // =========================================================================

        const renderHistory = () => {
            const db = getDB();
            const user = db.users.find(u => u.username === loggedInUsername);
            if (!user) return;

            elements.historyList.innerHTML = '';
            
            const history = user.history.sort((a, b) => b.timestamp - a.timestamp); // Sort by newest first

            if (history.length === 0) {
                elements.noHistoryMessage.classList.remove('hidden');
                return;
            }
            elements.noHistoryMessage.classList.add('hidden');

            history.forEach(item => {
                let iconClass, colorClass;
                let amountText = formatCurrency(Math.abs(item.amount));

                if (item.type === 'DEPOSIT' || item.type === 'BONUS' || item.type === 'CHECKIN' || item.type === 'COMMISSION' || (item.type === 'ADMIN_ADJUST' && item.amount > 0)) {
                    iconClass = 'fas fa-plus-circle';
                    colorClass = 'text-green-600';
                } else if (item.type === 'WITHDRAW' || item.type === 'VIP_BUY' || (item.type === 'ADMIN_ADJUST' && item.amount < 0)) {
                    iconClass = 'fas fa-minus-circle';
                    colorClass = 'text-red-600';
                } else {
                     iconClass = 'fas fa-info-circle';
                    colorClass = 'text-gray-500';
                }

                // Status Styling
                let statusClass = '';
                if (item.status === 'COMPLETED') statusClass = 'bg-green-100 text-green-800';
                if (item.status === 'PENDING') statusClass = 'bg-yellow-100 text-yellow-800';
                if (item.status === 'REJECTED') statusClass = 'bg-red-100 text-red-800';
                
                const typeText = item.type.replace('_', ' '); // For displaying 'VIP BUY' instead of 'VIP_BUY'

                const historyItem = document.createElement('div');
                historyItem.className = 'flex items-start justify-between p-3 bg-gray-50 rounded-lg border-l-4 border-indigo-400';
                historyItem.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <i class="${iconClass} text-xl ${colorClass}"></i>
                        <div>
                            <p class="font-semibold text-gray-800 capitalize">${typeText} - ${amountText}</p>
                            <p class="text-xs text-gray-500">${new Date(item.timestamp).toLocaleString('ne-NP')}</p>
                            <p class="text-xs text-gray-600 mt-1">${item.details}</p>
                        </div>
                    </div>
                    <span class="text-xs font-semibold px-2 py-1 rounded-full ${statusClass}">
                        ${item.status}
                    </span>
                `;
                elements.historyList.appendChild(historyItem);
            });
        };
        
        // =========================================================================
        // 8. INVITE LOGIC
        // =========================================================================
        
        const renderInviteTab = () => {
            const db = getDB();
            const user = db.users.find(u => u.username === loggedInUsername);
            if (!user) return;
            
            elements.myReferralCode.textContent = user.referralCode || 'N/A';
            
            // Filter users who were referred by the current user's referral code
            const referredUsers = db.users.filter(u => u.referredBy === user.referralCode);
            elements.totalReferrals.textContent = referredUsers.length;
            
            // Calculate total commission from history
            const totalCommission = user.history
                                      .filter(h => h.type === 'COMMISSION' && h.status === 'COMPLETED')
                                      .reduce((sum, h) => sum + h.amount, 0);
                                      
            elements.referralCommission.textContent = formatCurrency(totalCommission);
        };
        
        const copyReferralCode = () => {
            const code = elements.myReferralCode.textContent;
            navigator.clipboard.writeText(code).then(() => {
                showModal('सफलता', `रेफरल कोड '${code}' सफलतापूर्वक कपी भयो!`);
            }).catch(err => {
                 showModal('त्रुटि', 'कोड कपी गर्न असफल भयो। कृपया म्यानुअल रूपमा कपी गर्नुहोस्।');
            });
        };
        
        // =========================================================================
        // 9. ADMIN PANEL LOGIC
        // =========================================================================

        const renderAdminPanel = () => {
            const db = getDB();
            const user = db.users.find(u => u.username === loggedInUsername);
            if (!user || !user.isAdmin) return;

            // --- User Stats ---
            elements.totalUsersCount.textContent = db.users.length;
            const appTotalBalance = db.users.reduce((sum, u) => sum + u.balance, 0);
            elements.appTotalBalance.textContent = formatCurrency(appTotalBalance);
            
            // --- Settings UI Load ---
            elements.minDepositInput.value = db.appSettings.minDeposit;
            elements.minWithdrawInput.value = db.appSettings.minWithdraw;
            elements.telegramLinkInput.value = db.appSettings.telegramLink;
            elements.esewaIdInput.value = db.appSettings.esewaId; // Load eSewa ID
            elements.khaltiIdInput.value = db.appSettings.khaltiId; // Load Khalti ID
            elements.bankDetailsInput.value = db.appSettings.bankDetails; // Load Bank Details
            
            // --- Render VIP Management List ---
            elements.activeVipsList.innerHTML = '';
            db.vips.forEach(vip => {
                const vipDiv = document.createElement('div');
                vipDiv.className = 'flex justify-between items-center p-3 bg-white rounded-lg shadow-sm border border-yellow-300';
                vipDiv.innerHTML = `
                    <div>
                        <p class="font-bold text-gray-800">${vip.name} (${formatCurrency(vip.price)})</p>
                        <p class="text-sm text-gray-600">दैनिक आय: ${formatCurrency(vip.dailyIncome)} / ${vip.durationDays} दिन</p>
                    </div>
                    <button data-vip-id="${vip.id}" class="delete-vip-btn bg-red-500 text-white p-2 rounded-lg hover:bg-red-600"><i class="fas fa-trash-alt"></i></button>
                `;
                elements.activeVipsList.appendChild(vipDiv);
            });
            document.querySelectorAll('.delete-vip-btn').forEach(btn => {
                btn.addEventListener('click', handleDeleteVip);
            });

            // --- Render User Management List ---
            elements.userManagementList.innerHTML = '';
            db.users.filter(u => !u.isAdmin).forEach(u => {
                 const userDiv = document.createElement('div');
                userDiv.className = 'p-3 bg-white rounded-lg shadow-sm border border-blue-300';
                userDiv.innerHTML = `
                    <p class="font-bold text-gray-800">${u.username} (<span class="text-green-600">${formatCurrency(u.balance)}</span>)</p>
                    <p class="text-sm text-gray-600">Referral: ${u.referralCode} | Referred By: ${u.referredBy || 'N/A'}</p>
                    <div class="flex space-x-2 mt-2">
                        <input type="number" id="balance-input-${u.username}" class="w-24 px-2 py-1 border rounded-lg text-sm" placeholder="रकम">
                        <button data-username="${u.username}" class="add-balance-btn bg-blue-500 text-white px-2 py-1 rounded-lg text-sm hover:bg-blue-600">ब्यालेन्स थप्नुहोस्</button>
                    </div>
                `;
                elements.userManagementList.appendChild(userDiv);
            });
            document.querySelectorAll('.add-balance-btn').forEach(btn => {
                btn.addEventListener('click', handleAddBalance);
            });

            // --- Render Pending Deposits ---
            elements.pendingDepositsList.innerHTML = '';
            const pendingDeposits = db.pendingDeposits.filter(d => d.status === 'PENDING');
            if (pendingDeposits.length === 0) {
                 elements.pendingDepositsList.innerHTML = '<p class="text-gray-500">कुनै विचाराधीन जम्मा अनुरोध छैन।</p>';
            }
            pendingDeposits.forEach(d => {
                const depositDiv = document.createElement('div');
                depositDiv.className = 'p-3 bg-yellow-100 rounded-lg border border-yellow-400';
                depositDiv.innerHTML = `
                    <p class="font-bold text-gray-800">${d.username} ले ${formatCurrency(d.amount)} जम्मा गर्न चाहन्छन्।</p>
                    <p class="text-sm text-gray-600">विधि: ${d.method} | कोड: <span class="font-bold">${d.code}</span></p>
                    <p class="text-xs text-gray-500">${new Date(d.timestamp).toLocaleString('ne-NP')}</p>
                    <div class="flex space-x-2 mt-2">
                        <button data-id="${d.id}" data-username="${d.username}" data-amount="${d.amount}" class="approve-deposit-btn bg-green-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-green-600">स्वीकृत</button>
                        <button data-id="${d.id}" data-username="${d.username}" class="reject-deposit-btn bg-red-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-red-600">अस्वीकृत</button>
                    </div>
                `;
                elements.pendingDepositsList.appendChild(depositDiv);
            });
            document.querySelectorAll('.approve-deposit-btn').forEach(btn => {
                btn.addEventListener('click', handleApproveDeposit);
            });
            document.querySelectorAll('.reject-deposit-btn').forEach(btn => {
                btn.addEventListener('click', handleRejectDeposit);
            });

            // --- Render Pending Withdrawals ---
            elements.pendingWithdrawalsList.innerHTML = '';
            const pendingWithdrawals = db.pendingWithdrawals.filter(w => w.status === 'PENDING');
            if (pendingWithdrawals.length === 0) {
                 elements.pendingWithdrawalsList.innerHTML = '<p class="text-gray-500">कुनै विचाराधीन निकासी अनुरोध छैन।</p>';
            }
            pendingWithdrawals.forEach(w => {
                const withdrawalDiv = document.createElement('div');
                withdrawalDiv.className = 'p-3 bg-yellow-100 rounded-lg border border-yellow-400';
                withdrawalDiv.innerHTML = `
                    <p class="font-bold text-gray-800">${w.username} ले ${formatCurrency(w.amount)} निकाल्न चाहन्छन्।</p>
                    <p class="text-sm text-gray-600">विधि: ${w.method} | खाता: <span class="font-bold">${w.accountDetail}</span></p>
                    <p class="text-xs text-gray-500">${new Date(w.timestamp).toLocaleString('ne-NP')}</p>
                    <div class="flex space-x-2 mt-2">
                        <button data-id="${w.id}" data-username="${w.username}" data-amount="${w.amount}" class="approve-withdraw-btn bg-green-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-green-600">भुक्तानी गरियो/स्वीकृत</button>
                        <button data-id="${w.id}" data-username="${w.username}" data-amount="${w.amount}" class="reject-withdraw-btn bg-red-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-red-600">अस्वीकृत</button>
                    </div>
                `;
                elements.pendingWithdrawalsList.appendChild(withdrawalDiv);
            });
            document.querySelectorAll('.approve-withdraw-btn').forEach(btn => {
                btn.addEventListener('click', handleApproveWithdraw);
            });
            document.querySelectorAll('.reject-withdraw-btn').forEach(btn => {
                btn.addEventListener('click', handleRejectWithdraw);
            });
        };
        
        // Admin Handlers
        const handleAddVip = (e) => {
            e.preventDefault();
            const name = document.getElementById('vip-name').value.trim();
            const price = parseFloat(document.getElementById('vip-price').value);
            const dailyIncome = parseFloat(document.getElementById('vip-daily-income').value);
            const durationDays = parseInt(document.getElementById('vip-duration-days').value);

            if (name && price > 0 && dailyIncome > 0 && durationDays > 0) {
                let db = getDB();
                
                const newVip = {
                    id: getNextId(db.vips, 'V'),
                    name: name,
                    price: price,
                    dailyIncome: dailyIncome,
                    durationDays: durationDays
                };
                
                db.vips.push(newVip);
                saveDB(db);
                e.target.reset();
                showModal('सफलता', `${name} VIP योजना सफलतापूर्वक थपियो!`);
                renderAdminPanel();
                refreshDashboard(); // Update user VIP list
            } else {
                 showModal('त्रुटि', 'कृपया सबै VIP विवरणहरू सही रूपमा भर्नुहोस्।');
            }
        };
        
        const handleDeleteVip = (e) => {
            const vipId = e.currentTarget.getAttribute('data-vip-id');
            let db = getDB();
            
            // Remove from the main list
            db.vips = db.vips.filter(v => v.id !== vipId);
            
            // Remove from all active users (Crucial!)
            db.users.forEach(user => {
                user.activeVips = user.activeVips.filter(v => v.id !== vipId); 
            });

            saveDB(db);
            showModal('सफलता', 'VIP योजना सफलतापूर्वक मेटाइयो!');
            renderAdminPanel();
            refreshDashboard(); 
        };
        
        const handleFinancialLimits = (e) => {
            e.preventDefault();
            const minDeposit = parseFloat(elements.minDepositInput.value);
            const minWithdraw = parseFloat(elements.minWithdrawInput.value);

            let db = getDB();
            db.appSettings.minDeposit = minDeposit;
            db.appSettings.minWithdraw = minWithdraw;
            saveDB(db);
            showModal('सफलता', 'वित्तीय सीमाहरू सफलतापूर्वक बचत गरियो।');
            refreshDashboard(); // Update user UI
        };

        const handleAppSettings = (e) => {
             e.preventDefault();
             let db = getDB();
             
             db.appSettings.telegramLink = elements.telegramLinkInput.value.trim();
             db.appSettings.esewaId = elements.esewaIdInput.value.trim();
             db.appSettings.khaltiId = elements.khaltiIdInput.value.trim();
             db.appSettings.bankDetails = elements.bankDetailsInput.value.trim();

             saveDB(db);
             showModal('सफलता', 'एप सेटिङहरू सफलतापूर्वक बचत गरियो।');
             refreshDashboard(); 
        };
        
        const handleAddBalance = (e) => {
            const targetUsername = e.currentTarget.getAttribute('data-username');
            const amountInput = document.getElementById(`balance-input-${targetUsername}`);
            const amount = parseFloat(amountInput.value);

            if (isNaN(amount) || amount === 0) {
                 showModal('त्रुटि', 'कृपया वैध रकम प्रविष्ट गर्नुहोस्।');
                 return;
            }

            let db = getDB();
            const user = db.users.find(u => u.username === targetUsername);
            
            if (user) {
                user.balance += amount;
                
                 // Add history entry
                user.history.push({
                    type: 'ADMIN_ADJUST',
                    amount: amount,
                    status: 'COMPLETED',
                    timestamp: Date.now(),
                    details: `Admin added ${formatCurrency(amount)} to the balance.`
                });
                
                saveDB(db);
                showModal('सफलता', `${targetUsername} को ब्यालेन्समा ${formatCurrency(amount)} सफलतापूर्वक थपियो।`);
                amountInput.value = '';
                renderAdminPanel();
                if (loggedInUsername === targetUsername) refreshDashboard();
            }
        };

        // --- Pending Request Handlers ---

        const updateRequestStatus = (type, requestId, newStatus, transactionDetails) => {
            let db = getDB();
            let list = type === 'DEPOSIT' ? db.pendingDeposits : db.pendingWithdrawals;
            const requestIndex = list.findIndex(r => r.id === requestId);
            
            if (requestIndex !== -1) {
                const request = list[requestIndex];
                request.status = newStatus;
                
                // Update User Balance/History
                const user = db.users.find(u => u.username === request.username);
                if (user) {
                    // Find and update the history item based on request details
                    const historyItem = user.history.find(h => 
                        h.type === type && 
                        h.status === 'PENDING' && 
                        (type === 'WITHDRAW' ? (h.amount === request.amount * -1) : (h.amount === request.amount))
                    );
                    
                    if (newStatus === 'COMPLETED' && type === 'DEPOSIT') {
                        user.balance += request.amount;
                        showModal('सफलता', `${request.username} को खातामा ${formatCurrency(request.amount)} सफलतापूर्वक जम्मा गरियो।`);
                    }
                    
                    if (newStatus === 'REJECTED' && type === 'WITHDRAW') {
                        // Refund the amount deducted during withdrawal request
                        user.balance += request.amount;
                        showModal('जानकारी', `${request.username} को निकासी अनुरोध अस्वीकार गरियो र रकम ${formatCurrency(request.amount)} फिर्ता गरियो।`);
                    }

                    if (historyItem) {
                        historyItem.status = newStatus;
                        historyItem.details = historyItem.details + ` [Admin ${newStatus}]`;
                    }
                }
                
                saveDB(db);
                renderAdminPanel();
                if (user && user.username === loggedInUsername) refreshDashboard();
            }
        };

        const handleApproveDeposit = (e) => {
             const requestId = e.currentTarget.getAttribute('data-id');
             updateRequestStatus('DEPOSIT', requestId, 'COMPLETED', 'Approved by Admin');
        };

        const handleRejectDeposit = (e) => {
             const requestId = e.currentTarget.getAttribute('data-id');
             updateRequestStatus('DEPOSIT', requestId, 'REJECTED', 'Rejected by Admin');
        };

        const handleApproveWithdraw = (e) => {
             const requestId = e.currentTarget.getAttribute('data-id');
             updateRequestStatus('WITHDRAW', requestId, 'COMPLETED', 'Approved/Paid by Admin');
        };

        const handleRejectWithdraw = (e) => {
             const requestId = e.currentTarget.getAttribute('data-id');
             updateRequestStatus('WITHDRAW', requestId, 'REJECTED', 'Rejected by Admin, amount refunded');
        };


        // =========================================================================
        // 10. INITIALIZATION & EVENT LISTENERS
        // =========================================================================

        const init = () => {
             let db = getDB();
             
             // --- Load initial data or create Admin if missing ---
             if (!db.users.some(u => u.username === ADMIN_USERNAME)) {
                 db.users.push(initialDB.users[0]);
                 saveDB(db);
             }
             
             // --- Global Modal Listener ---
             elements.modalCloseBtn.addEventListener('click', hideModal);
             elements.modal.addEventListener('click', (e) => {
                 if (e.target.id === 'custom-modal') hideModal();
             });


             // --- Auth Listeners ---
             elements.loginForm.addEventListener('submit', handleLogin);
             elements.registerForm.addEventListener('submit', handleRegister);
             elements.showRegisterBtn.addEventListener('click', () => {
                 elements.loginView.classList.add('hidden');
                 elements.registerView.classList.remove('hidden');
             });
             elements.showLoginBtn.addEventListener('click', () => {
                 elements.registerView.classList.add('hidden');
                 elements.loginView.classList.remove('hidden');
             });
             elements.logoutBtn.addEventListener('click', handleLogout);
             
             // --- Dashboard Listeners ---
             elements.tabButtons.forEach(button => {
                 button.addEventListener('click', (e) => {
                     showTab(e.currentTarget.getAttribute('data-tab'));
                 });
             });
             elements.dailyCheckinBtn.addEventListener('click', handleDailyCheckin);
             
             // --- Deposit/Withdraw Listeners ---
             elements.depositForm.addEventListener('submit', handleDeposit);
             elements.withdrawForm.addEventListener('submit', handleWithdraw);
             
             // --- Invite Listener ---
             elements.copyReferralBtn.addEventListener('click', copyReferralCode);
             
             // --- Admin Listeners ---
             elements.addVipForm.addEventListener('submit', handleAddVip);
             elements.financialLimitsForm.addEventListener('submit', handleFinancialLimits);
             elements.settingsForm.addEventListener('submit', handleAppSettings);
             
             // --- Initial View Check ---
             if (loggedInUsername) {
                 showView('dashboard-view');
             } else {
                 showView('login-register-view');
             }
        };

        // Initialize the app when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', init);

    })();
    </script>
</body>
</html>